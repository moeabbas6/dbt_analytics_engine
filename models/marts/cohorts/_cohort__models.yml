version: 2

models:

  - name: fct_cohort_retention
    config:
      contract:
        enforced: true
    description: >
      A fact table that provides cohort analysis data, including both cumulative and point-in-time retention rates 
      for customer cohorts over elapsed months. This table enables insights into customer retention patterns and 
      behavior over time.


    columns:
      - name: id
        data_type: string
        constraints: 
          - type: not_null
          - type: primary_key
            warn_unenforced: false
        description: '{{ doc("id") }}'
        data_tests:
          - dbt_expectations.expect_column_value_lengths_to_equal:
              name: fct_cohort_retention_unexpected_id_length
              value: 32


      - name: cohort_month
        data_type: date
        constraints: 
          - type: not_null
        description: '{{ doc("cohort_month") }}'
        data_tests:
          - dbt_utils.not_constant
          - dbt_utils.accepted_range:
              name: fct_cohort_retention_unexpected_cohort_month
              max_value: "current_datetime()"


      - name: elapsed_month
        data_type: int64
        constraints: 
          - type: not_null
        description: '{{ doc("elapsed_month") }}'
        data_tests:
          - dbt_utils.not_constant
          - dbt_utils.expression_is_true:
              name: fct_cohort_retention_assert_positive_elapsed_month
              expression: ">= 0"


      - name: cohort_size
        data_type: int64
        constraints: 
          - type: not_null
        description: '{{ doc("cohort_size") }}'
        data_tests:
          - dbt_utils.not_constant
          - dbt_utils.expression_is_true:
              name: fct_cohort_retention_assert_positive_cohort_size
              expression: "> 0"


      - name: customers_retained
        data_type: int64
        constraints: 
          - type: not_null
        description: '{{ doc("customers_retained") }}'
        data_tests:
          - dbt_utils.not_constant
          - dbt_utils.expression_is_true:
              name: fct_cohort_retention_assert_positive_customers_retained
              expression: "> 0"
          - dbt_utils.expression_is_true:
              name: fct_cohort_retention_unexpected_customers_retained
              expression: "<= cohort_size"


      - name: churned_users
        data_type: int64
        constraints: 
          - type: not_null
        description: '{{ doc("churned_users") }}'
        data_tests:
          - dbt_utils.not_constant
          - dbt_utils.expression_is_true:
              name: fct_cohort_retention_assert_positive_churned_users
              expression: ">= 0"
          - dbt_utils.expression_is_true:
              name: fct_cohort_retention_unexpected_churned_users
              expression: "<= cohort_size"


      - name: cumulative_retention_rate
        data_type: float64
        constraints: 
          - type: not_null
        description: '{{ doc("cumulative_retention_rate") }}'
        data_tests:
          - dbt_utils.not_constant
          - dbt_utils.expression_is_true:
              name: fct_cohort_retention_assert_positive_cumulative_retention_rate
              expression: "> 0"
          - dbt_utils.expression_is_true:
              name: fct_cohort_retention_unexpected_cumulative_retention_rate
              expression: "<= 1"


      - name: active_customers
        data_type: int64
        constraints: 
          - type: not_null
        description: '{{ doc("active_customers") }}'
        data_tests:
          - dbt_utils.not_constant
          - dbt_utils.expression_is_true:
              name: fct_cohort_retention_assert_positive_active_customers
              expression: "> 0"
          - dbt_utils.expression_is_true:
              name: fct_cohort_retention_unexpected_active_customers
              expression: "<= cohort_size"
          


      - name: point_in_time_retention_rate
        data_type: float64
        constraints: 
          - type: not_null
        description: '{{ doc("point_in_time_retention_rate") }}'
        data_tests:
          - dbt_utils.not_constant
          - dbt_utils.expression_is_true:
              name: fct_cohort_retention_assert_positive_point_in_time_retention_rate
              expression: "> 0"
          - dbt_utils.expression_is_true:
              name: fct_cohort_retention_unexpected_point_in_time_retention_rate
              expression: "<= 1"