version: 2

models:
  - name: fct_customers_orders
    latest_version: 1
    versions:
      - v: 1
    config:
      contract:
        enforced: true 
    description: "This table contains information about customers and their related metrics such as order history, revenue, and segmentation."
    data_tests:
      - dbt_expectations.expect_table_aggregation_to_equal_other_table:
          expression: sum(total_gross_revenue)
          compare_model: ref("int_orders_payments_joined")
          compare_expression: sum(gross_revenue)
      - dbt_expectations.expect_table_aggregation_to_equal_other_table:
          expression: sum(total_net_revenue_after_tax)
          compare_model: ref("int_orders_payments_joined")
          compare_expression: sum(net_revenue_after_tax)
    columns:
      - name: customer_id
        data_type: string
        description: '{{ doc("customer_id") }}'
        constraints: 
          - type: not_null
          - type: primary_key
            warn_unenforced: false
        data_tests:
          - unique


      - name: last_order_days
        data_type: int64
        description: '{{ doc("last_order_days") }}'
        constraints: 
          - type: not_null
        data_tests:
          - dbt_utils.expression_is_true:
              expression: ">= 0"


      - name: first_order_date
        data_type: datetime
        description: '{{ doc("first_order_date") }}'
        constraints: 
          - type: not_null
        data_tests:
          - dbt_utils.accepted_range:
              max_value: "current_datetime()"


      - name: last_order_date
        data_type: datetime
        description: '{{ doc("last_order_date") }}'
        constraints: 
          - type: not_null
        data_tests:
          - dbt_utils.accepted_range:
              max_value: "current_datetime()"


      - name: customer_lifespan
        data_type: int64
        description: '{{ doc("customer_lifespan") }}'
        constraints: 
          - type: not_null
        data_tests:
          - dbt_utils.expression_is_true:
              expression: "> 0"

      - name: nb_order_ids
        data_type: int64
        description: '{{ doc("nb_order_id") }}'
        constraints: 
          - type: not_null
        data_tests:
          - dbt_utils.expression_is_true:
              expression: "> 0"


      - name: nb_shipping_ids
        data_type: int64
        description: '{{ doc("nb_shipping_id") }}'
        constraints: 
          - type: not_null
        data_tests:
          - dbt_utils.expression_is_true:
              expression: ">= 0"


      - name: nb_return_ids
        data_type: int64
        description: '{{ doc("nb_return_id") }}'
        constraints: 
          - type: not_null
        data_tests:
          - dbt_utils.expression_is_true:
              expression: ">= 0"


      - name: avg_fulfillment_days
        data_type: float64
        description: '{{ doc("avg_fulfillment_days") }}'
        data_tests:
          - dbt_utils.expression_is_true:
              expression: "> 0"
              config:
                where: "avg_fulfillment_days IS NOT NULL"


      - name: avg_nps_score
        data_type: float64
        description: '{{ doc("avg_nps_score") }}'
        data_tests:
          - dbt_utils.expression_is_true:
              expression: "> 0"
              config:
                where: "avg_nps_score IS NOT NULL"


      - name: total_gross_revenue
        data_type: float64
        description: '{{ doc("total_gross_revenue") }}'
        constraints: 
          - type: not_null
        data_tests:
          - dbt_utils.expression_is_true:
              expression: "> 0"


      - name: total_net_revenue_after_tax
        data_type: float64
        description: '{{ doc("total_net_revenue_after_tax") }}'
        constraints: 
          - type: not_null
        data_tests:
          - dbt_utils.expression_is_true:
              expression: "> 0"


      - name: avg_customer_lifespan
        data_type: float64
        description: '{{ doc("avg_customer_lifespan") }}'
        constraints: 
          - type: not_null
        data_tests:
          - dbt_utils.expression_is_true:
              expression: "> 0"


      - name: avg_orders_per_month
        data_type: float64
        description: '{{ doc("avg_orders_per_month") }}'
        constraints: 
          - type: not_null
        data_tests:
          - dbt_utils.expression_is_true:
              expression: "> 0"


      - name: aov
        data_type: float64
        description: '{{ doc("aov") }}'
        constraints: 
          - type: not_null
        data_tests:
          - dbt_utils.expression_is_true:
              expression: "> 0"


      - name: ltv
        data_type: float64
        description: '{{ doc("ltv") }}'
        constraints: 
          - type: not_null
        data_tests:
          - dbt_utils.expression_is_true:
              expression: "> 0"


      - name: recency
        data_type: string
        description: '{{ doc("recency") }}'
        constraints: 
          - type: not_null
        data_tests:
          - accepted_values:
              values: ['<90 days', '180-90 days', '180-365 days', '>365 days']


      - name: frequency
        data_type: string
        description: '{{ doc("frequency") }}'
        constraints: 
          - type: not_null
        data_tests:
          - accepted_values:
              values: ['1 order', '2 orders', '3+ orders']

      - name: segment
        data_type: string
        description: '{{ doc("segment") }}'
        data_tests:
          - accepted_values:
              values: ['Loyal Leader', 'Growing Patron', 'New Enthusiast', 'Casual Shopper', 'Waning Loyalty', 'Slipping Newcomer', 'At-Risk Regular', 'Vanished Buyer', 'One-Time Buyer', 'Dormant Customer']


      - name: segment_id
        data_type: int64
        description: '{{ doc("segment_id") }}'
        data_tests:
          - dbt_utils.accepted_range:
              min_value: 0
              max_value: 10
